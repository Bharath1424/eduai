/**
 * @fileoverview Firestore Security Rules for the EduAI Application
 * @version 1.0
 *
 * @description
 * This ruleset enforces a strict user-ownership model for the Firestore database.
 * The core philosophy is that users have complete control over their own data,
 * and no user can see or interact with another user's data. This provides a
 * strong foundation for privacy and security.
 *
 * Core Philosophy:
 * A user's data is private and can only be accessed by that user. This is achieved
 * by keying all user-specific data by their Firebase Authentication UID.
 * The ruleset defaults to denying all access and then selectively grants
 * permissions based on authenticated ownership.
 *
 * Data Structure:
 * The data is organized in a top-level `users` collection. Each document within
 * this collection is identified by a user's unique UID (`userId`), creating a
 * clear and secure path to their personal information: `/users/{userId}`.
 *
 * Key Security Decisions:
 * - User Listing Disabled: To protect user privacy and prevent data scraping,
 *   it is impossible for any client to list all documents in the `/users`
 *   collection. Users can only fetch their own document directly.
 * - Path-Based Ownership: All authorization checks are based on the user's UID
 *   present in the document path, which is a fast, secure, and cost-effective
 *   way to enforce ownership.
 * - Relational Integrity: On creation, the rules enforce that the `id` field
 *   within a user's document must match their UID from the path. This `id`
 *   field is then made immutable to prevent tampering with ownership records.
 *
 * Denormalization for Authorization:
 * This ruleset relies on the principle of using the document path `/users/{userId}`
 * as the source of truth for ownership. For relational integrity, the user document
s
 * itself must contain an `id` field that matches the `{userId}` from the path.
 * This avoids any need for cross-document `get()` calls, making the rules
 * both performant and simple.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the primary function for verifying document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document already exists and if the requester is the owner.
     * CRITICAL for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates required fields for creating a new user document.
     * In prototyping mode, this only enforces fields critical for authorization
     * and relational integrity, not the full data shape.
     */
    function hasValidUserDataOnCreate(userId) {
      // Enforce that the document's internal ID matches the user's Auth UID.
      // This creates a permanent, reliable link between the auth identity and the database record.
      return request.resource.data.id == userId;
    }

    /**
     * Validates that critical, immutable fields are not changed during an update.
     */
    function userDataIsImmutable() {
      // The user's unique ID must never change after the document is created.
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates required fields for creating a new topic document.
     */
    function hasValidTopicDataOnCreate(userId) {
      return request.resource.data.userId == userId
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.icon is string
        && request.resource.data.icon.size() > 0;
    }

    /**
     * Validates that critical, immutable fields for topics are not changed.
     */
    function topicDataIsImmutable() {
        return request.resource.data.userId == resource.data.userId;
    }

    // =====================================================================
    // Collection Rules: /users
    // =====================================================================

    /**
     * @description
     *   Rules for a user's own profile document. This is the root document for
     *   all of a user's private data.
     * @path
     *   /users/{userId}
     * @allow
     *   - (create): A newly signed-up user (UID: 'user123') can create their own profile document at `/users/user123`.
     *   - (get): The authenticated owner (UID: 'user123') can read their own document at `/users/user123`.
     *   - (update): The authenticated owner (UID: 'user123') can update their own document.
     * @deny
     *   - (list): No user, authenticated or not, can list all documents in the `/users` collection.
     *   - (get): A different user (UID: 'user456') cannot read another user's document at `/users/user123`.
     *   - (delete): A different user (UID: 'user456') cannot delete another user's document at `/users/user123`.
     * @principle
     *   Enforces strict document ownership. A user's data is private and only
     *   accessible by them. It also prevents enumeration of all system users.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && userDataIsImmutable();
      allow delete: if isExistingOwner(userId);

      // =====================================================================
      // Sub-collection Rules: /users/{userId}/topics
      // =====================================================================
      match /topics/{topicId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidTopicDataOnCreate(userId);
        allow update: if isExistingOwner(userId) && topicDataIsImmutable();
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}
